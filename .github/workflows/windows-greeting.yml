on:
  push:
    branches:
      - main

jobs:
  example_job:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Run Script
        run: echo "Hello, Windows!"
      - name: Download latest stable Xenia release
        shell: pwsh
        run: |
          # Get the latest stable release from Xenia Project
          $headers = @{
            "Accept" = "application/vnd.github+json"
            "Authorization" = "Bearer ${{ secrets.GITHUB_TOKEN }}"
            "X-GitHub-Api-Version" = "2022-11-28"
          }
          $releases = Invoke-RestMethod -Uri "https://api.github.com/repos/xenia-project/release-builds-windows/releases" -Headers $headers
          $stableRelease = $releases | Where-Object { $_.tag_name -like "*stable*" } | Select-Object -First 1

          if (-not $stableRelease) {
            Write-Host "No stable release found, using latest release instead"
            $stableRelease = $releases | Select-Object -First 1
          }

          Write-Host "Found release: $($stableRelease.tag_name)"

          # Find the ZIP asset
          $zipAsset = $stableRelease.assets | Where-Object { $_.name -like "*.zip" } | Select-Object -First 1

          if (-not $zipAsset) {
            Write-Error "No ZIP file found in the release assets"
            exit 1
          }

          Write-Host "Downloading: $($zipAsset.name)"
          Write-Host "Download URL: $($zipAsset.browser_download_url)"

          # Download the ZIP file
          Invoke-WebRequest -Uri $zipAsset.browser_download_url -OutFile "xenia-release.zip" -Headers $headers
          Write-Host "Download completed successfully"
      - name: Extract Xenia release
        shell: pwsh
        run: |
          # Extract the ZIP file
          Write-Host "Extracting xenia-release.zip..."
          Expand-Archive -Path "xenia-release.zip" -DestinationPath "xenia-extracted" -Force
          Write-Host "Extraction completed"
      - name: List extracted contents
        shell: pwsh
        run: |
          # List the contents of the extracted folder
          Write-Host "Contents of extracted Xenia release:"
          Get-ChildItem -Path "xenia-extracted" -Recurse | Select-Object FullName, Length | Format-Table -AutoSize
      - name: Execute xenia-vfs-dump.exe with --help
        shell: pwsh
        run: |
          # Execute xenia-vfs-dump.exe --help and capture output
          $exePath = Join-Path $env:GITHUB_WORKSPACE 'xenia-extracted\xenia-vfs-dump.exe'
          
          Write-Host "Attempting to execute: $exePath --help"
          
          # Check if the executable exists
          if (-not (Test-Path $exePath)) {
            Write-Warning "Executable not found at path: $exePath"
            Write-Host "Listing contents of xenia-extracted directory:"
            Get-ChildItem -Path "xenia-extracted" -Recurse | Select-Object FullName
            Write-Host "Skipping execution as executable was not found"
            exit 0
          }
          
          Write-Host "Executable found. Running with --help argument..."
          
          try {
            # Execute the command and capture output
            $output = & $exePath --help 2>&1
            $exitCode = $LASTEXITCODE
            
            Write-Host "=== Command Output ==="
            Write-Host $output
            Write-Host "=== End of Output ==="
            Write-Host "Exit code: $exitCode"
            
            # Check for common error patterns indicating headless/display issues
            $hasDisplayIssue = $output -imatch "headless|display|graphics"
            
            if ($hasDisplayIssue) {
              Write-Warning "The executable may require display/graphics support which is not available in headless environment"
              Write-Host "This is expected behavior for GUI applications running in CI/CD environments"
            }
            
            # Non-zero exit codes are acceptable for --help in some applications
            if ($exitCode -ne 0) {
              Write-Warning "Executable exited with code: $exitCode"
              Write-Host "Some applications return non-zero exit codes for --help, which may be normal"
            }
            
          } catch {
            Write-Warning "Failed to execute xenia-vfs-dump.exe: $_"
            Write-Host "Error details: $($_.Exception.Message)"
            
            # Check if it's a headless/display issue
            $hasDisplayIssue = $_.Exception.Message -imatch "headless|display|graphics"
            
            if ($hasDisplayIssue) {
              Write-Warning "This appears to be a headless support issue - the application may require a display"
              Write-Host "This is expected for GUI applications in CI/CD environments"
            }
            
            # Don't fail the workflow for expected errors
            Write-Host "Continuing workflow despite execution error..."
          }
