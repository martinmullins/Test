name: XenonRecomp Workflow

on:
  workflow_dispatch:
    inputs:
      xex_file_path:
        description: 'Path to the dolphin.xex file (relative to repository root)'
        required: false
        default: 'dolphin/dolphin.xex'
      output_directory:
        description: 'Directory for generated .cpp files'
        required: false
        default: 'generated_cpp'

jobs:
  recompile:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
      - name: Check out Test repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Set up Clang 18
        run: |
          # Add LLVM repository and install Clang 18 using modern gpg method
          wget -O - https://apt.llvm.org/llvm-snapshot.gpg.key | sudo gpg --dearmor -o /etc/apt/trusted.gpg.d/llvm.gpg
          echo "deb https://apt.llvm.org/$(lsb_release -cs)/ llvm-toolchain-$(lsb_release -cs)-18 main" | sudo tee /etc/apt/sources.list.d/llvm.list
          sudo apt-get update
          sudo apt-get install -y clang-18 clang++-18
          sudo update-alternatives --install /usr/bin/clang clang /usr/bin/clang-18 100
          sudo update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-18 100
          clang --version
          clang++ --version
      
      - name: Install CMake
        run: |
          sudo apt-get install -y cmake
          cmake --version
      
      - name: Clone XenonRecomp repository
        run: |
          cd ${{ github.workspace }}
          git clone --recursive https://github.com/hedge-dev/XenonRecomp.git
          cd XenonRecomp
          git log -1 --oneline
      
      - name: Build XenonRecomp
        run: |
          cd ${{ github.workspace }}/XenonRecomp
          mkdir -p build
          cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_C_COMPILER=clang-18 -DCMAKE_CXX_COMPILER=clang++-18
          cmake --build . --config Release
          echo "Build completed"
          ls -la
      
      - name: Verify XEX file exists
        run: |
          XEX_FILE="${{ github.workspace }}/${{ inputs.xex_file_path }}"
          if [ ! -f "$XEX_FILE" ]; then
            echo "ERROR: XEX file not found at $XEX_FILE"
            exit 1
          fi
          echo "XEX file found: $XEX_FILE"
          ls -lh "$XEX_FILE"
      
      - name: Create output directory
        run: |
          OUTPUT_DIR="${{ github.workspace }}/${{ inputs.output_directory }}"
          mkdir -p "$OUTPUT_DIR"
          echo "Output directory created: $OUTPUT_DIR"
      
      - name: Run XenonAnalyse to detect jump tables
        run: |
          cd ${{ github.workspace }}/XenonRecomp/build
          XEX_FILE="${{ github.workspace }}/${{ inputs.xex_file_path }}"
          JUMP_TABLES_OUTPUT="${{ github.workspace }}/jump_tables.toml"
          
          echo "Running XenonAnalyse to detect jump tables..."
          echo "Note: XenonAnalyse may fail if no jump tables are detected, which is acceptable"
          
          # XenonAnalyse may fail if no jump tables are detected, which is acceptable
          set +e  # Don't exit on error
          ./XenonAnalyse/XenonAnalyse "$XEX_FILE" "$JUMP_TABLES_OUTPUT" 2>&1 | tee xenonanalyse.log
          EXIT_CODE=$?
          set -e  # Re-enable exit on error
          
          if [ $EXIT_CODE -eq 0 ]; then
            echo "✓ XenonAnalyse completed successfully"
          elif [ $EXIT_CODE -eq 139 ]; then
            echo "⚠ XenonAnalyse crashed with segmentation fault (exit code 139)"
            echo "This may indicate the XEX file format is not fully supported"
            echo "Continuing with empty jump tables file..."
          else
            echo "⚠ XenonAnalyse exited with code $EXIT_CODE"
            echo "This may be expected if no jump tables were found"
          fi
          
          if [ -f "$JUMP_TABLES_OUTPUT" ]; then
            echo ""
            echo "Jump tables TOML generated:"
            head -n 20 "$JUMP_TABLES_OUTPUT"
          else
            echo ""
            echo "No jump tables TOML generated, creating empty file"
            touch "$JUMP_TABLES_OUTPUT"
          fi
      
      - name: Extract function addresses from map file
        id: extract_addresses
        run: |
          MAP_FILE="${{ github.workspace }}/dolphin/dolphin.map"
          
          if [ ! -f "$MAP_FILE" ]; then
            echo "WARNING: Map file not found at $MAP_FILE"
            echo "Using default addresses (may cause issues)"
            echo "restgprlr_14=0x820930a0" >> $GITHUB_OUTPUT
            echo "savegprlr_14=0x82093050" >> $GITHUB_OUTPUT
            echo "restfpr_14=0x82097d8c" >> $GITHUB_OUTPUT
            echo "savefpr_14=0x82097d40" >> $GITHUB_OUTPUT
            echo "restvmx_14=0x8226a4c8" >> $GITHUB_OUTPUT
            echo "savevmx_14=0x8226a230" >> $GITHUB_OUTPUT
            echo "restvmx_64=0x8226a55c" >> $GITHUB_OUTPUT
            echo "savevmx_64=0x8226a2c4" >> $GITHUB_OUTPUT
          else
            echo "Extracting function addresses from map file..."
            
            # Extract addresses for required runtime functions
            # Using word boundary to match exact function names
            RESTGPRLR_14=$(grep -w "__restgprlr_14" "$MAP_FILE" | head -1 | awk '{print $3}')
            SAVEGPRLR_14=$(grep -w "__savegprlr_14" "$MAP_FILE" | head -1 | awk '{print $3}')
            RESTFPR_14=$(grep -w "__restfpr_14" "$MAP_FILE" | head -1 | awk '{print $3}')
            SAVEFPR_14=$(grep -w "__savefpr_14" "$MAP_FILE" | head -1 | awk '{print $3}')
            RESTVMX_14=$(grep -w "__restvmx_14" "$MAP_FILE" | head -1 | awk '{print $3}')
            SAVEVMX_14=$(grep -w "__savevmx_14" "$MAP_FILE" | head -1 | awk '{print $3}')
            RESTVMX_64=$(grep -w "__restvmx_64" "$MAP_FILE" | head -1 | awk '{print $3}')
            SAVEVMX_64=$(grep -w "__savevmx_64" "$MAP_FILE" | head -1 | awk '{print $3}')
            
            echo "Found addresses:"
            echo "  __restgprlr_14: $RESTGPRLR_14"
            echo "  __savegprlr_14: $SAVEGPRLR_14"
            echo "  __restfpr_14: $RESTFPR_14"
            echo "  __savefpr_14: $SAVEFPR_14"
            echo "  __restvmx_14: $RESTVMX_14"
            echo "  __savevmx_14: $SAVEVMX_14"
            echo "  __restvmx_64: $RESTVMX_64"
            echo "  __savevmx_64: $SAVEVMX_64"
            
            # Convert to hex format with 0x prefix
            echo "restgprlr_14=0x${RESTGPRLR_14}" >> $GITHUB_OUTPUT
            echo "savegprlr_14=0x${SAVEGPRLR_14}" >> $GITHUB_OUTPUT
            echo "restfpr_14=0x${RESTFPR_14}" >> $GITHUB_OUTPUT
            echo "savefpr_14=0x${SAVEFPR_14}" >> $GITHUB_OUTPUT
            echo "restvmx_14=0x${RESTVMX_14}" >> $GITHUB_OUTPUT
            echo "savevmx_14=0x${SAVEVMX_14}" >> $GITHUB_OUTPUT
            echo "restvmx_64=0x${RESTVMX_64}" >> $GITHUB_OUTPUT
            echo "savevmx_64=0x${SAVEVMX_64}" >> $GITHUB_OUTPUT
          fi
      
      - name: Create XenonRecomp configuration file
        run: |
          XEX_FILE="${{ github.workspace }}/${{ inputs.xex_file_path }}"
          OUTPUT_DIR="${{ github.workspace }}/${{ inputs.output_directory }}"
          JUMP_TABLES_FILE="${{ github.workspace }}/jump_tables.toml"
          CONFIG_FILE="${{ github.workspace }}/xenonrecomp_config.toml"
          
          cat > "$CONFIG_FILE" << EOF
          [main]
          file_path = "${{ inputs.xex_file_path }}"
          out_directory_path = "${{ inputs.output_directory }}"
          switch_table_file_path = "jump_tables.toml"
          
          restgprlr_14_address = ${{ steps.extract_addresses.outputs.restgprlr_14 }}
          savegprlr_14_address = ${{ steps.extract_addresses.outputs.savegprlr_14 }}
          restfpr_14_address = ${{ steps.extract_addresses.outputs.restfpr_14 }}
          savefpr_14_address = ${{ steps.extract_addresses.outputs.savefpr_14 }}
          restvmx_14_address = ${{ steps.extract_addresses.outputs.restvmx_14 }}
          savevmx_14_address = ${{ steps.extract_addresses.outputs.savevmx_14 }}
          restvmx_64_address = ${{ steps.extract_addresses.outputs.restvmx_64 }}
          savevmx_64_address = ${{ steps.extract_addresses.outputs.savevmx_64 }}
          
          [optimizations]
          skip_lr = false
          skip_msr = false
          ctr_as_local = false
          xer_as_local = false
          reserved_as_local = false
          cr_as_local = false
          non_argument_as_local = false
          non_volatile_as_local = false
          EOF
          
          echo "Configuration file created:"
          cat "$CONFIG_FILE"
      
      - name: Validate configuration
        run: |
          CONFIG_FILE="${{ github.workspace }}/xenonrecomp_config.toml"
          
          echo "Validating configuration file..."
          
          # Check if all required addresses are non-zero and non-empty
          RESTGPRLR_14="${{ steps.extract_addresses.outputs.restgprlr_14 }}"
          SAVEGPRLR_14="${{ steps.extract_addresses.outputs.savegprlr_14 }}"
          RESTFPR_14="${{ steps.extract_addresses.outputs.restfpr_14 }}"
          SAVEFPR_14="${{ steps.extract_addresses.outputs.savefpr_14 }}"
          RESTVMX_14="${{ steps.extract_addresses.outputs.restvmx_14 }}"
          SAVEVMX_14="${{ steps.extract_addresses.outputs.savevmx_14 }}"
          RESTVMX_64="${{ steps.extract_addresses.outputs.restvmx_64 }}"
          SAVEVMX_64="${{ steps.extract_addresses.outputs.savevmx_64 }}"
          
          VALIDATION_FAILED=false
          
          if [ -z "$RESTGPRLR_14" ] || [ "$RESTGPRLR_14" = "0x0" ] || [ "$RESTGPRLR_14" = "0x" ]; then
            echo "ERROR: __restgprlr_14 address is missing or invalid: '$RESTGPRLR_14'"
            VALIDATION_FAILED=true
          fi
          
          if [ -z "$SAVEGPRLR_14" ] || [ "$SAVEGPRLR_14" = "0x0" ] || [ "$SAVEGPRLR_14" = "0x" ]; then
            echo "ERROR: __savegprlr_14 address is missing or invalid: '$SAVEGPRLR_14'"
            VALIDATION_FAILED=true
          fi
          
          if [ -z "$RESTFPR_14" ] || [ "$RESTFPR_14" = "0x0" ] || [ "$RESTFPR_14" = "0x" ]; then
            echo "ERROR: __restfpr_14 address is missing or invalid: '$RESTFPR_14'"
            VALIDATION_FAILED=true
          fi
          
          if [ -z "$SAVEFPR_14" ] || [ "$SAVEFPR_14" = "0x0" ] || [ "$SAVEFPR_14" = "0x" ]; then
            echo "ERROR: __savefpr_14 address is missing or invalid: '$SAVEFPR_14'"
            VALIDATION_FAILED=true
          fi
          
          if [ -z "$RESTVMX_14" ] || [ "$RESTVMX_14" = "0x0" ] || [ "$RESTVMX_14" = "0x" ]; then
            echo "ERROR: __restvmx_14 address is missing or invalid: '$RESTVMX_14'"
            VALIDATION_FAILED=true
          fi
          
          if [ -z "$SAVEVMX_14" ] || [ "$SAVEVMX_14" = "0x0" ] || [ "$SAVEVMX_14" = "0x" ]; then
            echo "ERROR: __savevmx_14 address is missing or invalid: '$SAVEVMX_14'"
            VALIDATION_FAILED=true
          fi
          
          if [ -z "$RESTVMX_64" ] || [ "$RESTVMX_64" = "0x0" ] || [ "$RESTVMX_64" = "0x" ]; then
            echo "ERROR: __restvmx_64 address is missing or invalid: '$RESTVMX_64'"
            VALIDATION_FAILED=true
          fi
          
          if [ -z "$SAVEVMX_64" ] || [ "$SAVEVMX_64" = "0x0" ] || [ "$SAVEVMX_64" = "0x" ]; then
            echo "ERROR: __savevmx_64 address is missing or invalid: '$SAVEVMX_64'"
            VALIDATION_FAILED=true
          fi
          
          if [ "$VALIDATION_FAILED" = "true" ]; then
            echo ""
            echo "WARNING: Some required function addresses are missing or invalid"
            echo "XenonRecomp may not work correctly with this XEX file"
            echo "Please ensure the map file contains all required runtime function symbols"
          else
            echo "✓ All required addresses are valid"
          fi
          
          echo "Configuration validation complete"
      
      - name: Run XenonRecomp to generate C++ files
        run: |
          cd ${{ github.workspace }}
          CONFIG_FILE="${{ github.workspace }}/xenonrecomp_config.toml"
          PPC_CONTEXT_HEADER="${{ github.workspace }}/XenonRecomp/XenonUtils/ppc_context.h"
          OUTPUT_DIR="${{ github.workspace }}/${{ inputs.output_directory }}"
          
          echo "Running XenonRecomp..."
          echo "Note: This may take several minutes for large XEX files..."
          
          # Run XenonRecomp with timeout protection
          set +e  # Don't exit on error
          timeout 300 ./XenonRecomp/build/XenonRecomp/XenonRecomp "$CONFIG_FILE" "$PPC_CONTEXT_HEADER" 2>&1 | tee xenonrecomp.log
          EXIT_CODE=$?
          set -e  # Re-enable exit on error
          
          echo ""
          echo "XenonRecomp exit code: $EXIT_CODE"
          
          if [ $EXIT_CODE -eq 0 ]; then
            echo "✓ XenonRecomp completed successfully"
          elif [ $EXIT_CODE -eq 124 ]; then
            echo "ERROR: XenonRecomp timed out after 5 minutes"
            echo "The XEX file may be too large or XenonRecomp encountered an infinite loop"
            exit 1
          elif [ $EXIT_CODE -eq 139 ]; then
            echo "ERROR: XenonRecomp crashed with a segmentation fault (exit code 139)"
            echo ""
            echo "This typically indicates one of the following issues:"
            echo "1. The XEX file format may not be fully supported by XenonRecomp"
            echo "2. Required function addresses may be incorrect or missing"
            echo "3. The XEX file may have characteristics that XenonRecomp cannot handle"
            echo ""
            echo "XenonRecomp was designed for games like Sonic Unleashed and may not"
            echo "work correctly with all Xbox 360 executables."
            echo ""
            echo "Last output from XenonRecomp:"
            tail -20 xenonrecomp.log || true
            
            # Check if any output was generated before crash
            if [ -d "$OUTPUT_DIR" ] && [ "$(ls -A $OUTPUT_DIR 2>/dev/null)" ]; then
              echo ""
              echo "⚠ Partial output was generated before crash:"
              find "$OUTPUT_DIR" -type f | head -10
              echo "Continuing with partial output..."
            else
              echo ""
              echo "✗ No output was generated"
              echo "Workflow cannot continue without generated C++ files"
              exit 1
            fi
          else
            echo "ERROR: XenonRecomp failed with exit code $EXIT_CODE"
            echo ""
            echo "Last output from XenonRecomp:"
            tail -20 xenonrecomp.log || true
            
            # Check if partial output was generated
            if [ -d "$OUTPUT_DIR" ] && [ "$(ls -A $OUTPUT_DIR 2>/dev/null)" ]; then
              echo ""
              echo "⚠ Partial output was generated, continuing with workflow"
            else
              echo ""
              echo "✗ No output was generated, failing workflow"
              exit 1
            fi
          fi
          
          echo "Checking generated files:"
          ls -lah "$OUTPUT_DIR" || echo "Output directory is empty or does not exist"
      
      - name: List generated C++ files
        run: |
          OUTPUT_DIR="${{ github.workspace }}/${{ inputs.output_directory }}"
          if [ -d "$OUTPUT_DIR" ]; then
            echo "Generated C++ files:"
            find "$OUTPUT_DIR" -type f -name "*.cpp" -o -name "*.h" | head -20
            
            echo ""
            echo "Total file count:"
            find "$OUTPUT_DIR" -type f | wc -l
          else
            echo "No output directory found"
            exit 1
          fi
      
      - name: Configure Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
      
      - name: Commit and push generated files
        run: |
          OUTPUT_DIR="${{ github.workspace }}/${{ inputs.output_directory }}"
          
          # Check if output directory exists and has files
          if [ ! -d "$OUTPUT_DIR" ]; then
            echo "Output directory does not exist, nothing to commit"
            exit 0
          fi
          
          git add ${{ inputs.output_directory }}
          
          # Add jump tables file if it exists
          if [ -f "jump_tables.toml" ]; then
            git add jump_tables.toml
          fi
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Add generated C++ files from XenonRecomp workflow"
            git push
            echo "Changes pushed successfully"
          fi
      
      - name: Upload generated files as artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: xenonrecomp-output
          path: |
            ${{ inputs.output_directory }}
            jump_tables.toml
            xenonrecomp_config.toml
          retention-days: 7
